# Fundr

A decentralized crowdfunding platform built on Web3 with an indexer-first data architecture.

**Live Demo**: [https://fundr-web.vercel.app/](https://fundr-web.vercel.app/)

## Overview

Fundr is a complete Web3 crowdfunding data stack with the following core components:

- **Indexer-first data sourcing** - Chain data indexing via `apps/indexer` and Drizzle ORM
- **Fastify API** - Single source of truth for frontend and edge cache
- **Cloudflare Edge Worker** - Caching layer between API and Next.js UI
- **Next.js 15 Frontend** - App Router implementation that never interacts with blockchain directly

## Architecture

Data flow: `Blockchain â†’ apps/indexer (viem) â†’ PostgreSQL (packages/db) â†’ apps/api (Fastify + Drizzle) â†’ apps/edge (Cloudflare KV) â†’ apps/web (Next.js 15)`

Core principles:

- `apps/web` and `apps/edge` only read from `apps/api`
- Only `apps/indexer` interacts with the blockchain
- API layer is the single data source for frontend and edge

## Modules

- **apps/indexer** - WebSocket indexing service that listens to on-chain events and writes to PostgreSQL
- **packages/db** - Shared Drizzle database schema (campaigns + checkpoints)
- **apps/api** - Fastify REST API that wraps Drizzle queries
- **apps/edge** - Cloudflare Worker that proxies API requests with KV caching
- **apps/web** - Next.js 15 frontend using React Query + wagmi + viem
- **packages/contracts** - Foundry smart contracts
- **scripts/** - Deployment and environment configuration scripts

---

## Getting Started

### Prerequisites

- **Node.js** 20+
- **pnpm** 9+
- **Foundry** (forge, anvil, cast) - [Installation Guide](https://book.getfoundry.sh/getting-started/installation)
- **jq** - `brew install jq` (macOS) or `apt install jq` (Linux)
- **PostgreSQL** (optional, for full stack mode)

### Install Dependencies

```bash
pnpm install
```

---

## Local Development

### Quick Start (Recommended)

**One command to start the complete local development environment:**

```bash
pnpm dev:local
```

This command will:

1. Start **Anvil** local blockchain (chainId: 31337, port: 8545)
2. Deploy smart contracts automatically
3. Update all `.env.local` files with contract addresses
4. Start **Edge Worker** (port: 8787)
5. Start **Next.js** frontend (port: 3000)

### Full Stack Mode (with Indexer + API)

If you need the complete data pipeline (requires local PostgreSQL):

```bash
pnpm dev:local:full
```

This additionally starts:

- **Event Indexer** - Listens to chain events (uses `.env.local`)
- **Fastify API** - Data service on port 3001 (uses `.env.local`)

### Important Notes

> âš ï¸ **Anvil starts with a fresh, empty blockchain every time.**
> Each restart of Anvil requires re-deploying contracts.

> ğŸ”’ **Local environment is completely isolated:**
> - Local Indexer/API will **NOT** connect to Sepolia or production databases
> - All services use `.env.local` files which are auto-generated
> - The deploy script validates Chain ID = 31337 before deployment

> ğŸ“¦ **Data Sources:**
> - **Basic mode** (`dev:local`): Frontend uses chain fallback to read data directly
> - **Full mode** (`dev:local:full`): Frontend reads from Indexer â†’ API â†’ Edge

### Manual Steps (Alternative)

If you prefer manual control:

```bash
# Terminal 1: Start Anvil
pnpm chain:local:start

# Terminal 2: Deploy contracts (after Anvil is running)
pnpm contracts:deploy:local

# Terminal 3: Start Edge Worker
pnpm edge:dev:local

# Terminal 4: Start Frontend
pnpm web:dev:local

# Optional (requires local PostgreSQL):
# Terminal 5: Start API (explicitly loads .env.local)
pnpm api:dev:local

# Terminal 6: Start Indexer (explicitly loads .env.local)
pnpm indexer:dev:local
```

---

## Environment Configuration

### Environment File Structure

Each sub-project uses environment-specific files:

```
apps/
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ .env.local          # Local development (auto-generated)
â”‚   â””â”€â”€ .env.example        # Template
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ .env.local          # Local development
â”‚   â”œâ”€â”€ .env.sepolia        # Sepolia testnet
â”‚   â””â”€â”€ .env.example        # Template
â”œâ”€â”€ indexer/
â”‚   â”œâ”€â”€ .env.local          # Local development (auto-generated)
â”‚   â”œâ”€â”€ .env.sepolia        # Sepolia testnet
â”‚   â””â”€â”€ .env.example        # Template
â””â”€â”€ edge/
    â”œâ”€â”€ .dev.vars           # Local development (auto-generated)
    â”œâ”€â”€ .dev.vars.example   # Template
    â””â”€â”€ wrangler.jsonc      # Production config
```

### Security Rules

- âœ… Only `.env.example` and `.dev.vars.example` are committed to Git
- âŒ All real env files (`.env.local`, `.env.sepolia`, `.dev.vars`) are gitignored
- âŒ Local scripts cannot connect to Sepolia or production databases
- âŒ Deploy scripts validate Chain ID before execution

### apps/web/.env.local

```env
# Auto-generated by deploy-contracts-local.sh

# Edge Worker (local)
NEXT_PUBLIC_EDGE=http://127.0.0.1:8787

# Blockchain (Anvil local chain)
NEXT_PUBLIC_RPC_URL=http://127.0.0.1:8545
NEXT_PUBLIC_CHAIN_ID=31337
NEXT_PUBLIC_FACTORY=0x...
NEXT_PUBLIC_DEPLOY_BLOCK=0

# Pinata IPFS (preserved across deployments)
PINATA_JWT=your_pinata_jwt
NEXT_PUBLIC_GATEWAY_URL=your_gateway.mypinata.cloud
```

### apps/indexer/.env.local

```env
# Auto-generated by deploy-contracts-local.sh

# Blockchain RPC (Anvil)
RPC_HTTP=http://127.0.0.1:8545
RPC_WSS=ws://127.0.0.1:8545

# Chain Configuration
CHAIN_ID=31337
FACTORY=0x...
DEPLOY_BLOCK=0

# Local Database
DATABASE_URL=postgresql://localhost:5432/fundr_local
```

### apps/api/.env.local

```env
# Local Database
DATABASE_URL=postgresql://localhost:5432/fundr_local
PORT=3001
NODE_ENV=development
CORS_ORIGIN=*
```

### apps/edge/.dev.vars

```env
# Auto-generated by dev-local.sh
API_URL=http://127.0.0.1:3001
```

---

## Scripts Reference

### Local Development

| Script | Description |
|--------|-------------|
| `pnpm dev:local` | ğŸš€ **Recommended** - Start complete local dev environment |
| `pnpm dev:local:full` | Start full stack (includes indexer + api) |
| `pnpm dev:local:ui` | Start only edge + web (assumes chain is running) |

### Individual Services (Local)

| Script | Description |
|--------|-------------|
| `pnpm chain:local:start` | Start Anvil local blockchain |
| `pnpm contracts:deploy:local` | Deploy contracts to local Anvil |
| `pnpm web:dev:local` | Start Next.js frontend |
| `pnpm edge:dev:local` | Start Cloudflare Edge Worker |
| `pnpm api:dev:local` | Start Fastify API (loads `.env.local`) |
| `pnpm indexer:dev:local` | Start event indexer (loads `.env.local`) |

### Sepolia Testnet

| Script | Description |
|--------|-------------|
| `pnpm contracts:deploy:sepolia` | Deploy contracts to Sepolia |
| `pnpm indexer:dev:sepolia` | Start indexer for Sepolia (loads `.env.sepolia`) |
| `pnpm api:dev:sepolia` | Start API for Sepolia (loads `.env.sepolia`) |
| `pnpm dev:sepolia` | Start indexer + api for Sepolia |

### Deployment

| Script | Description |
|--------|-------------|
| `pnpm contracts:build` | Build smart contracts |
| `pnpm edge:deploy:cloudflare` | Deploy Edge Worker to Cloudflare |
| `pnpm indexer:deploy:flyio` | Deploy Indexer to Fly.io |

---

## Core Features

- **Real-time synced campaigns** - Indexer listens for `CampaignCreated` events
- **Edge caching layer** - Cloudflare Worker provides KV read-through caching
- **Modern frontend** - Next.js 15 App Router with Tailwind CSS, React Query, wagmi
- **Smart contracts** - Foundry contracts with automated ABI sync

---

## Tech Stack

- **Frontend**: Next.js 15, React 19, TypeScript, Tailwind CSS v4, wagmi, viem
- **Backend**: Fastify, Drizzle ORM, PostgreSQL
- **Indexer**: Node.js, viem (WebSocket), Drizzle ORM
- **Edge**: Cloudflare Workers, KV
- **Smart Contracts**: Foundry, Solidity 0.8.30
- **Tooling**: pnpm workspaces, TypeScript, dotenv-cli
