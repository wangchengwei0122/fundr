# Fundr

A decentralized crowdfunding platform built on Web3 with an indexer-first data architecture.

**Live Demo**: [https://fundr-web.vercel.app/](https://fundr-web.vercel.app/)

## Overview

Fundr is a complete Web3 crowdfunding data stack with the following core components:

- **Indexer-first data sourcing** - Chain data indexing via `apps/indexer` and Drizzle ORM
- **Fastify API** - Single source of truth for frontend and edge cache
- **Cloudflare Edge Worker** - Caching layer between API and Next.js UI
- **Next.js 15 Frontend** - App Router implementation that never interacts with blockchain directly

## Architecture

Data flow: `Blockchain → apps/indexer (viem) → PostgreSQL (packages/db) → apps/api (Fastify + Drizzle) → apps/edge (Cloudflare KV) → apps/web (Next.js 15)`

Core principles:

- `apps/web` and `apps/edge` only read from `apps/api`
- Only `apps/indexer` interacts with the blockchain
- API layer is the single data source for frontend and edge

## Modules

- **apps/indexer** - WebSocket indexing service that listens to on-chain events and writes to PostgreSQL. Includes batching, retry/backoff, checkpoints, and periodic refresh mechanisms
- **packages/db** - Shared Drizzle database schema (campaigns + checkpoints) ensuring data consistency between indexer and API
- **apps/api** - Fastify REST API that wraps Drizzle queries, provides filtering/pagination, and serves as the single data source for frontend and edge
- **apps/edge** - Cloudflare Worker that proxies API requests, implements KV read-through caching, keeping logic minimal (no blockchain access)
- **apps/web** - Next.js 15 frontend using React Query + wagmi + viem for wallet interactions, all data reads go through Edge Worker
- **packages/contracts** - Foundry smart contracts with ABI outputs synchronized across the workspace
- **scripts/** - Helper scripts for ABI/address sync, database migrations, deployments, and environment configuration

## Getting Started

### Prerequisites

- **Node.js** 20+
- **pnpm** 9+
- **Foundry** (forge, anvil, cast) - [Installation Guide](https://book.getfoundry.sh/getting-started/installation)
- **jq** - `brew install jq` (macOS) or `apt install jq` (Linux)

### Install Dependencies

```bash
pnpm install
```

---

## Local Development

### Quick Start (Recommended)

One command to start the complete local development environment:

```bash
pnpm dev:local
```

This command will:

1. Start **Anvil** local blockchain (chainId: 31337, port: 8545)
2. Deploy smart contracts automatically
3. Update `apps/web/.env.local` with contract addresses
4. Start **Edge Worker** (port: 8787)
5. Start **Next.js** frontend (port: 3000)

### Full Stack Mode (with Indexer + API)

If you need the complete data pipeline (requires local PostgreSQL):

```bash
pnpm dev:local:full
```

This additionally starts:

- **Event Indexer** - Listens to chain events
- **Fastify API** - Data service (port: 3001)

### Important Notes

> **Warning:** Anvil starts with a fresh, empty blockchain every time.
> Each restart of Anvil requires re-deploying contracts.

> **Data Sources:**
> - **Basic mode** (`dev:local`): Frontend uses chain fallback to read data directly
> - **Full mode** (`dev:local:full`): Frontend reads from Indexer → API → Edge

### Manual Steps (Alternative)

If you prefer manual control:

```bash
# Terminal 1: Start Anvil
pnpm chain:local:start

# Terminal 2: Deploy contracts (after Anvil is running)
pnpm contracts:deploy:local

# Terminal 3: Start Edge Worker
pnpm edge:local:start

# Terminal 4: Start Frontend
pnpm web:local:start

# Optional (requires DATABASE_URL):
# Terminal 5: Start API
pnpm api:local:start

# Terminal 6: Start Indexer
pnpm indexer:local:start
```

---

## Environment Variables

### apps/web/.env.local

```env
# Edge Worker endpoint
NEXT_PUBLIC_EDGE=http://127.0.0.1:8787

# Blockchain configuration (auto-generated by deploy script)
NEXT_PUBLIC_RPC_URL=http://127.0.0.1:8545
NEXT_PUBLIC_CHAIN_ID=31337
NEXT_PUBLIC_FACTORY=0x...
NEXT_PUBLIC_DEPLOY_BLOCK=0

# Pinata IPFS (required for file uploads)
PINATA_JWT=your_pinata_jwt
NEXT_PUBLIC_GATEWAY_URL=your_gateway.mypinata.cloud
```

### apps/indexer/.env (for production/testnet)

```env
RPC_HTTP=https://your-rpc-endpoint
RPC_WSS=wss://your-websocket-endpoint
CHAIN_ID=11155111
FACTORY=0x...
DEPLOY_BLOCK=9729410
DATABASE_URL=postgresql://...
```

### apps/api/.env

```env
DATABASE_URL=postgresql://...
PORT=3001
```

---

## Scripts Reference

### Local Development

| Script | Description |
|--------|-------------|
| `pnpm dev:local` | Start local dev environment (chain + deploy + edge + web) |
| `pnpm dev:local:full` | Start full stack (includes indexer + api) |
| `pnpm dev:local:ui` | Start only edge + web (assumes chain is running) |

### Individual Services

| Script | Description |
|--------|-------------|
| `pnpm chain:local:start` | Start Anvil local blockchain |
| `pnpm contracts:deploy:local` | Deploy contracts to local Anvil |
| `pnpm web:local:start` | Start Next.js frontend |
| `pnpm edge:local:start` | Start Cloudflare Edge Worker |
| `pnpm api:local:start` | Start Fastify API server |
| `pnpm indexer:local:start` | Start event indexer |

### Build & Deploy

| Script | Description |
|--------|-------------|
| `pnpm contracts:build` | Build smart contracts |
| `pnpm contracts:deploy:sepolia` | Deploy to Sepolia testnet |
| `pnpm edge:deploy:cloudflare` | Deploy Edge Worker to Cloudflare |
| `pnpm indexer:deploy:flyio` | Deploy Indexer to Fly.io |

## Core Features

- **Real-time synced campaigns** - Indexer listens for `CampaignCreated` events, extracts goal/deadline, and writes data to `campaigns` and `checkpoints` tables
- **Edge caching layer** - Cloudflare Worker provides KV read-through caching for faster UI loads
- **Modern frontend** - Next.js 15 App Router with server components, Tailwind CSS, React Query, wagmi, and viem
- **Smart contracts & tooling** - Foundry contracts and scripts ensure ABI/address deployment synchronization

## Development Guide

### Smart Contracts

```bash
# Run tests
pnpm --filter @packages/contracts test
# or
forge test

# Build contracts
pnpm contracts:build

# Deploy locally
pnpm contracts:deploy:local:auto

# Deploy to Sepolia
pnpm contracts:deploy:sepolia
```

### Database Migrations

```bash
# Generate migration files
pnpm db:generate

# Push migrations to database
pnpm db:push
```

## Tech Stack

- **Frontend**: Next.js 15, React, TypeScript, Tailwind CSS, wagmi, viem
- **Backend**: Fastify, Drizzle ORM, PostgreSQL
- **Indexer**: Node.js, viem (WebSocket), Drizzle ORM
- **Edge**: Cloudflare Workers, KV
- **Smart Contracts**: Foundry, Solidity 0.8.30
- **Tooling**: pnpm workspaces, TypeScript
